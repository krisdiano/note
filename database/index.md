[TOC]

# 索引

你能搞出多高性能的数据库，很大程度上取决于你对索引的了解程度，所以本篇归纳一下相关的知识点。

## 索引到底是什么

索引是一种提高查询效率的数据结构，不过为了维护查询的高效率，每次修改操作会付出一定的代价。

## 索引模型

一提到索引，自然会想到B+树，但是索引只是提高查询效率的数据结构，并不是特定的数据结构，两者之间不是简单的对等关系。

可以使用有序数组，哈希表，搜索树（包括但不限于这三种类型，比如还可以是跳表）等数据结构来实现索引，具体选用哪一种数据结构，需要结合特定的场景。

| 数据结构 | 优点               | 缺点                 |
| -------- | ------------------ | -------------------- |
| 有序数组 | 等值查询，范围查询 | 只适用于静态存储引擎 |
| 哈希表   | 等值查询           | 范围查询             |
| 搜索树   | 等值查询，范围查询 |                      |

## Mysql索引

由于使用Mysql的场景较多，而且也是大多数开发者入门接触的数据库，所以以Mysql为例，学习其中的知识点。

### 索引模型

Mysql中的索引模型是B+树

### 索引基本知识

#### 主键索引

以主键为关键词，叶子节点存储的是整行数据，也被称之为聚簇索引

#### 非主键索引

自定义的关键词，叶子节点存储的该行数据对应的主键，也被称之为二级索引

#### 覆盖索引

覆盖索引是一种特殊的二级索引，特殊在它需要结合查询的条件来确定。简单的说，如果某次查询，二级索引叶子节点中的数据可以满足查询而不需要回表则称此二级索引在当前查询条件下是覆盖索引

#### 最左前缀

对于B+树这种索引模型，如果关键词不是单一字段，而是符合字段，那么就可以使用最左前缀，举一个例子说明最左前缀的现象：

索引的关键词是name，age...等字段，最左的字段是name，所以当查询条件使用name时，mysql也会使用维护的索引来查询，而不是全表扫描。（需要注意的最左的含义不是最左的一个字段，而是最左的连续字段，使用name，age查询也会应用最左前缀）

所以如果索引的关键词是多个，需要根据查询的场景考虑如何安排顺序

#### 索引下推

索引下推是针对于二级索引的，其次是基于最左前缀的，当定位到索引中的第一个节点时，如果查询的字段索引不能覆盖，就需要回表，但是为了避免无意义的回表，会先使用关键词中包含的字段直接过滤不符合条件的记录，这就是索引下推。（低版本的没有索引下推，而是直接回表）

### Q&A

#### 基于主键和非主键的索引查询有什么不同

- 基于主键索引查询：只需要搜索主键索引树即可得到数据
- 基于非主键索引查询：先搜索非主键索引树找到对应主键，再搜索主键索引树才可得到数据（回表）

#### 为什么主键通常是自增的整数

这个问题可以细分为两个：

1. 为什么主键通常是自增的：因为索引是需要维护的，每次插入数据时，如果主键是自增的，可以直接插入，否则就需要调整数据，带来维护上的代价
2. 为什么主键通常是整数类型：这主要是考虑到二级索引的空间成本，由于二级索引的叶子节点存储的是主键，而整数占用的空间较小，所以选用整数类型









